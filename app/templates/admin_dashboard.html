{% extends "base.html" %}
{% block title %}Panel de Administrador{% endblock %}

{% block content %}
<link rel="stylesheet" href="/static/css/style_admin.css">

<nav class="admin-navbar">
  <a href="/" class="logo">Panel Admin</a>
  <form method="get" action="/dashboard" class="admin-search">
    <input type="text" name="q" placeholder="Buscar obra..." value="{{ request.query_params.q or '' }}">
    <button type="submit">Buscar</button>
  </form>
  <form method="get" action="/logout">
    <button type="submit" class="logout-btn">Cerrar sesi√≥n</button>
  </form>
</nav>


<div class="tabs">
  <button onclick="mostrarTab('obras')" class="active">üìö Obras</button>
  <button onclick="mostrarTab('usuarios')">üë• Usuarios</button>
  <button onclick="mostrarTab('agregar')">‚ûï Agregar obra</button>
</div>

<div id="obras" class="tab-content active">
  {% for libro in disponibles %}
    <div class="libro-card">
      <div class="libro-info">
        <img src="{{ libro.imagen_url }}" alt="{{ libro.titulo }}">
        <h3>{{ libro.titulo }}</h3>
        <p>{{ libro.sinopsis }}</p>
      </div>
      <div class="libro-acciones">
        <p><strong>Stock:</strong> {{ libro.stock }}</p>
        <p><strong>Estado:</strong> {{ "Visible" if libro.activo else "Oculta" }}</p>

        <form method="post" action="/obras/{{ libro.id }}/alternar">
          <button type="submit" class="secondary-btn">
            {% if libro.activo %} Ocultar {% else %} Mostrar {% endif %}
          </button>
        </form>

        <details>
          <summary>‚úèÔ∏è Editar obra</summary>
          <form method="post" action="/obras/{{ libro.id }}/actualizar" enctype="multipart/form-data" class="form-editar">
            <label>T√≠tulo:</label>
            <input type="text" name="titulo" value="{{ libro.titulo }}" required>

            <label>Sinopsis:</label>
            <textarea name="sinopsis" required>{{ libro.sinopsis }}</textarea>

            <label>Imagen:</label>
            <input type="file" name="imagen">

            <label>Stock:</label>
            <input type="number" name="stock" value="{{ libro.stock }}" required>

            <button type="submit">Actualizar</button>
          </form>
        </details>

        <form method="post" action="/obras/{{ libro.id }}/eliminar-definitivo">
          <button type="submit" class="danger">Eliminar definitivamente</button>
        </form>

        <h4>Usuarios que agregaron esta obra:</h4>
        <ul>
          {% for entrada in libro.usuarios %}
            <li>{{ entrada.usuario.email }} - {{ entrada.fecha_agregado.strftime('%Y-%m-%d') }}</li>
          {% else %}
            <li><em>Nadie ha agregado este libro.</em></li>
          {% endfor %}
        </ul>
      </div>
    </div>
  {% else %}
    <p>No hay libros a√∫n.</p>
  {% endfor %}
</div>

<div id="usuarios" class="tab-content">
  <h2>Usuarios registrados</h2>
  {% for entrada in datos %}
    <div class="usuario-card">
      <p><strong>{{ entrada.usuario.nombre }} {{ entrada.usuario.apellido }}</strong> ‚Äî {{ entrada.usuario.email }}</p>
      <p><strong>Estado:</strong> {{ "Activo" if entrada.usuario.activo else "Inactivo" }}</p>
      <form method="post" action="/usuarios/{{ entrada.usuario.id }}/alternar">
        <button type="submit">{% if entrada.usuario.activo %}Inactivar{% else %}Activar{% endif %}</button>
      </form>
      <form method="post" action="/usuarios/{{ entrada.usuario.id }}/eliminar">
        <button type="submit" class="danger">Eliminar usuario</button>
      </form>
      <h4>Libros agregados:</h4>
      <ul>
        {% for libro in entrada.libros %}
          <li>{{ libro.libro.titulo }}</li>
        {% else %}
          <li><em>No ha agregado libros.</em></li>
        {% endfor %}
      </ul>
    </div>
  {% endfor %}
</div>

<div id="agregar" class="tab-content">
  <h3>Agregar nueva obra</h3>
  <form method="post" action="/obras/crear" enctype="multipart/form-data">
    <label>T√≠tulo:</label><br>
    <input type="text" name="titulo" required><br><br>

    <label>Sinopsis:</label><br>
    <textarea name="sinopsis" required></textarea><br><br>

    <label>Imagen:</label><br>
    <input type="file" name="imagen" accept="image/*" required><br><br>

    <label>Stock inicial:</label><br>
    <input type="number" name="stock" value="10" required><br><br>

    <button type="submit">Agregar libro</button>
  </form>
</div>

<script>
function mostrarTab(id) {
  const tabs = document.querySelectorAll('.tab-content');
  const botones = document.querySelectorAll('.tabs button');
  tabs.forEach(tab => tab.classList.remove('active'));
  botones.forEach(btn => btn.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  event.target.classList.add('active');
}
</script>
{% endblock %}
